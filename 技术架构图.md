# Network-RC 技术架构图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             用户控制层 (User Control Layer)                   │
├─────────────────────────────────────────────────────────────────────────────┤
│  Web浏览器  │  移动端  │  游戏手柄  │  键盘  │  RC遥控器  │  触屏操作  │  AI控制  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           网络通信层 (Network Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  WebSocket  │  WebRTC  │  HTTP/HTTPS  │  FRP穿透  │  NAT穿透  │  点对点连接  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          应用服务层 (Application Layer)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  控制服务  │  视频服务  │  音频服务  │  配置服务  │  状态服务  │  会话管理  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           硬件抽象层 (Hardware Layer)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  GPIO控制  │  PWM输出  │  摄像头  │  麦克风  │  扬声器  │  I2C总线  │  ADC转换  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             硬件平台 (Hardware Platform)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  树莓派  │  舵机  │  电调  │  电机  │  车灯  │  云台  │  传感器  │  执行器  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 软件架构详细图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             前端应用 (Frontend)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  React App (Port 3000)                                                      │
│  ├── Controller.js     # 控制器组件                                         │
│  ├── Camera.js         # 摄像头组件                                         │
│  ├── Joystick.js       # 摇杆组件                                           │
│  ├── Gamepad.js        # 游戏手柄组件                                       │
│  ├── Keyboard.js       # 键盘控制组件                                       │
│  ├── Setting.js        # 设置组件                                           │
│  └── Redux Store       # 状态管理                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │ WebSocket/HTTP
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             后端服务 (Backend)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  Node.js Server (Port 8080)                                                 │
│  ├── index.js           # 主入口文件                                        │
│  ├── lib/                                                                   │
│  │   ├── app.js         # Express应用                                       │
│  │   ├── status.js      # 状态管理                                          │
│  │   ├── CameraServer.js # 摄像头服务器                                     │
│  │   ├── AudioServer.js  # 音频服务器                                       │
│  │   ├── MicrophoneServer.js # 麦克风服务器                                 │
│  │   ├── WebRTC/        # WebRTC模块                                        │
│  │   ├── tts/           # 语音合成                                          │
│  │   ├── frpc/          # 网络穿透                                          │
│  │   ├── gpio.js        # GPIO控制                                          │
│  │   └── channel.js     # 通道控制                                          │
│  └── package.json       # 项目配置                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             系统服务 (System Services)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ffmpeg        # 视频编码/解码                                              │
│  pulseaudio    # 音频系统                                                   │
│  frpc          # 网络穿透客户端                                             │
│  rpio          # GPIO控制库                                                 │
│  rpio-pwm      # PWM信号控制                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             硬件接口 (Hardware Interface)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  树莓派 GPIO  │  USB摄像头  │  音频设备  │  I2C设备  │  PWM输出  │  数字IO  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流架构

### 控制数据流
```
用户输入 → 前端处理 → WebSocket → 后端解析 → 通道控制 → GPIO输出 → 硬件执行
    │           │           │           │           │           │
    ▼           ▼           ▼           ▼           ▼           ▼
  触屏/键盘   事件处理    实时传输    消息路由     PWM/开关    舵机/电机
```

### 视频数据流
```
摄像头 → ffmpeg编码 → WebSocket传输 → 前端解码 → Canvas显示
   │         │             │             │           │
   ▼         ▼             ▼             ▼           ▼
  USB设备    H.264      二进制流      Broadway    实时画面
```

### 音频数据流
```
麦克风 → 音频采集 → WebSocket传输 → 前端播放
   │         │             │           │
   ▼         ▼             ▼           ▼
 音频设备   PCM数据     实时传输    音频输出
```

## 模块依赖关系

```
index.js (主入口)
├── lib/app.js (Express应用)
├── lib/status.js (状态管理)
├── lib/CameraServer.js (摄像头服务)
├── lib/AudioServer.js (音频服务)
├── lib/MicrophoneServer.js (麦克风服务)
├── lib/WebRTC/ (WebRTC模块)
├── lib/tts/ (语音合成)
├── lib/frpc/ (网络穿透)
├── lib/gpio.js (GPIO控制)
├── lib/channel.js (通道控制)
└── lib/unit.js (工具函数)
```

## 网络架构

### 本地网络模式
```
┌─────────────┐    WiFi/LAN    ┌─────────────┐
│   用户设备   │ ◄────────────► │   树莓派    │
│  (浏览器)   │                │ (Network-RC)│
└─────────────┘                └─────────────┘
```

### 远程网络模式
```
┌─────────────┐    Internet    ┌─────────────┐    LAN    ┌─────────────┐
│   用户设备   │ ◄────────────► │  FRP服务器  │ ◄────────► │   树莓派    │
│  (浏览器)   │                │ (穿透服务)  │           │ (Network-RC)│
└─────────────┘                └─────────────┘           └─────────────┘
```

### WebRTC点对点模式
```
┌─────────────┐    WebRTC      ┌─────────────┐
│   用户设备   │ ◄────────────► │   树莓派    │
│  (浏览器)   │   (P2P)       │ (Network-RC)│
└─────────────┘                └─────────────┘
```

## 安全架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             安全层 (Security Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  密码认证  │  会话管理  │  权限控制  │  数据加密  │  网络安全  │  审计日志  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           应用层 (Application Layer)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  用户登录  │  控制验证  │  配置保护  │  通信加密  │  访问控制  │  操作记录  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 性能架构

### 实时性保证
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             性能优化层 (Performance Layer)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  低延迟传输  │  硬件编码  │  流式处理  │  缓存机制  │  连接池  │  负载均衡  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           技术实现层 (Implementation Layer)                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  WebSocket  │  ffmpeg   │  Stream   │  Redis    │  Pool     │  Cluster    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 扩展架构

### 插件系统
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             扩展层 (Extension Layer)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  AI插件  │  传感器插件  │  执行器插件  │  通信插件  │  存储插件  │  分析插件  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           核心系统 (Core System)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  控制核心  │  视频核心  │  音频核心  │  网络核心  │  配置核心  │  状态核心  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 部署架构

### 开发环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   前端开发   │    │   后端开发   │    │   硬件测试   │
│  (React)   │    │  (Node.js)  │    │  (树莓派)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 生产环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   用户访问   │    │   网络服务   │    │   硬件部署   │
│  (浏览器)   │    │  (FRP/NAT)  │    │  (树莓派)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 监控架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             监控层 (Monitoring Layer)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  性能监控  │  状态监控  │  错误监控  │  网络监控  │  硬件监控  │  用户监控  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据收集层 (Data Collection Layer)                │
├─────────────────────────────────────────────────────────────────────────────┤
│  日志收集  │  指标收集  │  事件收集  │  状态收集  │  配置收集  │  用户行为  │
└─────────────────────────────────────────────────────────────────────────────┘
```

这个技术架构图展示了Network-RC项目的完整技术架构，从用户控制层到硬件平台，涵盖了系统的各个层面和组件关系。 